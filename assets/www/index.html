<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, minimum-scale=1, maximum-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="jquery.mobile/jquery.mobile-1.0.1.min.css" />
        <!--link rel="stylesheet" href="css/jquery.jqplot.min.css" />
        <link href="css/basic.css" type="text/css" rel="stylesheet" /-->
        <link href="css/visualize.css" type="text/css" rel="stylesheet" />
        <link href="css/visualize-light.css" type="text/css" rel="stylesheet" />
        <style>
            /* App custom styles */
            div.graph
        {
            width: 230px;
            height: 230px;
            float: left;
            border: 1px dashed gainsboro;
        }
        </style><script src="js/phonegap-1.4.1.js">
        </script>
        <script language="javascript" type="text/javascript" src="js/excanvas.js"></script>
        <script src="js/jquery-1.7.1.min.js">
        </script>
        <script src="jquery.mobile/jquery.mobile-1.0.1.min.js">
        </script>
        <script src="js/config.js">
        </script>
        <script language="javascript" type="text/javascript" src="js/jquery.flot.js"></script>
        <script language="javascript" type="text/javascript" src="js/jquery.flot.pie.js">
        </script>
        <!--script src="js/pie.js">
        </script-->

    <body>
        <div data-role="page" id="login">
            <div data-theme="d" data-role="header" data-position="fixed">
                <h3>
                    Sondeo
                </h3>
            </div>
            <div data-role="content">
                <form url="" action="POST">
                    <img src="images/logout.png" width="20px" >
                    <span>LOGIN</span>
                    <div data-role="fieldcontain">
                        <fieldset data-role="controlgroup">
                            <label for="username">
                            </label>
                            <input id="username" placeholder="Nombre de Usuario" value="" type="text" />
                        
                            <label for="password">
                            </label>
                            <input id="password" placeholder="Password" value="" type="password" />
                        </fieldset>
                    </div>
                    <input type="submit" data-inline="true" data-icon="plus" data-iconpos="left" value="Login" id="sub" />
                </form>
                <div id="resultBlock"></div>
            </div>
        </div>

        <!-- ACA COMIENZA OTRA PAGINA -->
        <div data-role="page" id="bienvenido">
            <div data-theme="a" data-role="header">
                <h3>
                    Sondeo
                </h3>
                <a data-role="button" data-transition="fade" data-theme="a" data-icon="delete" data-iconpos="left" id="salir">
                    Salir
                </a>
            </div>
            <div data-role="content">
                <!--ul data-role="listview" data-divider-theme="b" data-inset="true">
                    <li data-role="list-divider" role="heading">
                        Divider
                    </li>
                    <li data-theme="c">
                        <a href="#" data-transition="slide">
                            Button
                        </a>
                    </li>
                    <li data-theme="c">
                        <a href="#page1" data-transition="slide">
                            Button
                        </a>
                    </li>
                    <li data-theme="c">
                        <a href="#page1" data-transition="slide">
                            Button
                        </a>
                    </li>
                </ul-->


                    <div id="default" class="graph"></div>
                
            </div>
            <div data-theme="a" data-role="footer">
                <div data-role="navbar" data-iconpos="top">
                    <ul>
                        <li>
                            <a href="#bienvenido" data-theme="" data-icon="myhome" class="ui-btn-active">
                                Inicio
                            </a>
                        </li>
                        <li>
                            <a href="#" data-theme="" data-icon="grid" data-transition="pop">
                                Menu
                            </a>
                        </li>
                        <li>
                            <a href="#cambiar_pass" data-theme="" data-icon="padlock" data-transition="pop">
                                Contrase&ntilde;a
                            </a>
                        </li>
                        <li>
                            <a href="#" data-theme="" data-icon="tools" class="config" data-transition="pop">
                                Config.
                            </a>
                        </li>
                    </ul>
                </div>
                <h3>
                    <span class="nombre"></span>
                </h3>
            </div>
        </div>

        <!-- Pagina de cambio de contraseña -->
        <div data-role="page" id="cambiar_pass">
            <div data-theme="a" data-role="header" data-position="fixed">
                <h3>
                    Sondeo
                </h3>
                <a data-role="button" data-rel="back" data-transition="fade" data-theme="a" data-icon="back" data-iconpos="left">
                    Atras
                </a>
            </div>
            <div data-role="content">
                <form url="" action="POST">
                    
                    <span>Cambio de Contrase&ntilde;a</span>
                    <div data-role="fieldcontain">
                        <fieldset data-role="controlgroup">
                            <input id="old_password" placeholder="Contrase&ntilde;a" value="" type="password" />
                            <br />                        
                            <input id="nb_password" placeholder="Nueva Contrase&ntilde;a" value="" type="password" />
                            <br />                        
                            <input id="con_nb_password" placeholder="Repetir Nueva Contrase&ntilde;a" value="" type="password" />
                        </fieldset>
                    </div>
                    <input type="submit" data-inline="true" data-icon="check" data-iconpos="left" value="Guardar" id="g_pass" />
                </form>
                <div id="resultBlock"></div>
            </div>
            <div data-theme="a" data-role="footer">
                <div data-role="navbar" data-iconpos="top">
                    <ul>
                        <li>
                            <a href="#bienvenido" data-theme="" data-icon="myhome" data-transition="pop">
                                Inicio
                            </a>
                        </li>
                        <li>
                            <a href="#" data-theme="" data-icon="grid" data-transition="pop">
                                Menu
                            </a>
                        </li>
                        <li>
                            <a href="#" data-theme="" data-icon="padlock" class="ui-btn-active">
                                Contrase&ntilde;a
                            </a>
                        </li>
                        <li>
                            <a href="#" data-theme="" data-icon="tools" class="config" data-transition="pop">
                                Config.
                            </a>
                        </li>
                    </ul>
                </div>
                <h3>
                    <span class="nombre"></span>
                </h3>
            </div>
        </div>
        
       <script>

       // var p = new pie();
       //  p.add("Jan",100);
       //  p.add("Feb",200);
       //  p.add("Mar",150);
       //  p.add("Apr",120);
       //  p.add("May",315);
       //  p.add("Jun",415);
       //  p.add("Jul",315);
       //  p.render("pieCanvas", "Pie Graph")

       var login=null;
       var storage = window.localStorage;    

       var data = [
            { label: "Series1",  data: 10},
            { label: "Series2",  data: 30},
            { label: "Series3",  data: 90},
            { label: "Series4",  data: 70},
            { label: "Series5",  data: 80},
            { label: "Series6",  data: 110}
        ];  

       function iniciar_session() {
           var url ="http://"+host+"/iniciar.json?login="+$("#username").val()+"&password="+$("#password").val();    
                $.ajax({
                      url: url,
                      timeout: 10000,
                      type:'get',
                      beforeSend: function( xhr ) {
                         $.mobile.showPageLoadingMsg("b", "Cargando...", true);
                      },
                      success: function( data ) {
                        login=data;
                        if (login.status!='ERROR'){
                            $(".nombre").html(login.usuario.name);
                            storage.setItem("username",$("#username").val());
                            storage.setItem("password",$("#password").val());
                            storage.setItem("login",JSON.stringify(login));
                            $.mobile.changePage( "#bienvenido", { transition: "slideup"} );
                        }else{
                            alert(login.message);
                        }

                      },
                      error: function(){
                         navigator.notification.alert(
                            'Imposible conectar con el Servidor!',  // message
                            null,         // callback
                            'Error',            // title
                            'OK'                  // buttonName
                        );
                      },

                      complete: function(){
                        $.mobile.hidePageLoadingMsg();
                      }
                    });
       }

       function alertDismissed(button) {
        if (button==1) navigator.app.exitApp();
            // do something
            //alert('You selected button ' + button);
        }
        
        function cerrar_session(button) {
            if (button==1) {
                storage.clear();
                navigator.app.exitApp();
            }
            // do something
            //alert('You selected button ' + button);
        }
        


        function salir () {
             navigator.notification.confirm(
                '¿Desea Salir?',  // message
                 alertDismissed,             // callback to invoke with index of button pressed
                'Sondeo',            // title
                'OK,Cancelar'          // buttonLabels
            );
        }

        function onEndCallKeyDown(){
            navigator.notification.confirm(
                '¿Desea Salir?',  // message
                 cerrar_session,             // callback to invoke with index of button pressed
                'Sondeo',            // title
                'OK,Cancelar'          // buttonLabels
            );
        }

        $(document).ready(function() {

            
           

            //alert(storage.getItem('username') +  ' ' + storage.getItem('password'))
            //document.addEventListener("menubutton", onEndCallKeyDown, false);
            //$('.pie').hide();
            // $('.pie').visualize({
            //         type: 'pie',
            //         width: 200,
            //         appendKey: false,
            //         appendTitle: false,
            //         //pieMargin: 10,
            //         title: '2009 Total Sales by Individual'
            //         //interaction: true,
            //         //tooltip: true
            //     });

            // var plot1 = $.jqplot('pie1', [[['PRueba 1',25],['PRueba 2',14],['PRueba 3',7],['PRueba 3',30]]], {
            //     gridPadding: {top:0, bottom:38, left:0, right:0},
            //     seriesDefaults:{
            //         renderer:$.jqplot.PieRenderer, 
            //         trendline:{ show:false }, 
            //         rendererOptions: { padding: 8, showDataLabels: true }
            //     },
            //     legend:{
            //         show:true, 
            //         placement: 'outside', 
            //         rendererOptions: {
            //             numberRows: 1
            //         }, 
            //         location:'s',
            //         marginTop: '15px'
            //     }       
            // });
            if(storage.getItem("username") != null && storage.getItem("password") != null){
                $('#username').val(storage.getItem("username"));
                $('#password').val(storage.getItem("password"));
                iniciar_session();
            }

            login=storage.getItem("login")
            //if(login!='null'){}


            $(".config").click(function(e){
                onEndCallKeyDown();
            });

            $("#salir").click(function(e){
                salir();               
            });

            $("#g_pass").click(function(e){
                e.preventDefault();
                var url ="http://"+host+"/users/cambiar_pass.json";    
                $.ajax({
                  url: url,
                  data:{'n_pass':$('#nb_password').val(),'cn_pass':$('#con_nb_password').val(),
                        'password':$("#old_password").val(),'login':storage.getItem('username'),'id':login.usuario.id},
                  timeout: 10000,
                  type:'POST',
                  beforeSend: function( xhr ) {
                     $.mobile.showPageLoadingMsg("b", "Cargando...", true);
                  },
                  success: function( data ) {
                    alert(data.message);
                    if (data.status!='ERROR'){
                        history.back();  
                    
                    }

                  },
                  error: function(){
                     navigator.notification.alert(
                        'Imposible conectar con el Servidor!',  // message
                        null,         // callback
                        'Error',            // title
                        'OK'                  // buttonName
                    );
                  },

                  complete: function(){
                    $.mobile.hidePageLoadingMsg();
                  }
                });
                               
            });

            $("#sub").click(function(e) {
                e.preventDefault();
                iniciar_session();
            });

             $.plot($("#default"), data, 
            {
                series: {
                    pie: { 
                        show: true,
                        radius: 1,
                        label: {
                            show: true,
                            radius: 1,
                            formatter: function(label, series){
                                return '<div style="font-size:8pt;text-align:center;padding:2px;color:black;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                            },
                            background: { opacity: 0.8 }
                        }
                    }
                },
                legend: {
                    show: false
                }
            });
        });
        </script>
    </body>
</html>